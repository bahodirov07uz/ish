{% extends 'base.html' %}
{% load static %}
{% block content %}

<link rel="stylesheet" href="{% static 'css/employees_list.css' %}">

<div class="app">
    <div class="main-content">
        <header class="header">
            <button class="menu-toggle" id="menuToggle">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 12h18M3 6h18M3 18h18" />
                </svg>
            </button>
            <div class="header-title">Ishchilar</div>
            <button class="theme-toggle-mobile" id="themeToggleMobile">
                <svg class="sun-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <circle cx="10" cy="10" r="4" />
                    <path
                        d="M10 1v2m0 14v2M19 10h-2M3 10H1m15.07-6.07l-1.41 1.41M5.34 14.66l-1.41 1.41m12.14 0l-1.41-1.41M5.34 5.34L3.93 3.93" />
                </svg>
                <svg class="moon-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <path d="M17 10.5A7 7 0 1 1 9.5 3a5.5 5.5 0 0 0 7.5 7.5z" />
                </svg>
            </button>
        </header>

        <main class="content">
            <div class="page">
                <div class="page-header">
                    <div>
                        <h2>Ishchilar</h2>
                        <p>Barcha ishchilarni ko'ring va boshqaring</p>
                    </div>
                    <button class="btn btn-primary" id="addEmployeeBtn">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M10 5v10M5 10h10" />
                        </svg>
                        <span>Yangi ishchi</span>
                    </button>
                </div>

                <div class="search-bar">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="9" cy="9" r="6" />
                        <path d="M13 13l4 4" />
                    </svg>
                    <input type="text" id="employeeSearch" placeholder="Ishchilarni qidirish...">
                </div>

                <div id="employeesGrid" class="items-grid">
                    <!-- Django engine orqali ishchilarni yuklash -->
                    {% if ishchilar %}
                    {% for ishchi in ishchilar %}
                    <div class="item-card">
                        <a href="{% url 'main:employee_detail' ishchi.id %}">
                            <div class="item-card-header">
                                <div class="item-title">{{ ishchi.ism }} {{ ishchi.familiya }}</div>
                                <div class="item-subtitle">
                                    {% if ishchi.turi %}
                                    {{ ishchi.turi.nomi }}
                                    {% else %}
                                    Lavozim belgilanmagan
                                    {% endif %}
                                </div>
                            </div>
                        </a>
                        <div class="item-card-body">
                            <div class="item-info">
                                <div class="item-info-row">
                                    <svg width="16" height="16" viewBox="0 0 20 20" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <path
                                            d="M12 1H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2z" />
                                        <path d="M8 7h4M8 11h8M8 15h6" />
                                    </svg>
                                    <span>Maosh: {{ ishchi.maosh|floatformat:0 }} so'm</span>
                                </div>
                                <div class="item-info-row">
                                    <svg width="16" height="16" viewBox="0 0 20 20" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" />
                                        <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" />
                                    </svg>
                                    <span>Telefon: {{ ishchi.telefon }}</span>
                                </div>
                                <div class="item-info-row">
                                    <svg width="16" height="16" viewBox="0 0 20 20" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <circle cx="10" cy="10" r="8" />
                                        <path d="M7 10l2 2 4-4" />
                                    </svg>
                                    <span>Status:
                                        <span
                                            class="badge {% if ishchi.is_oylik_open %}badge-success{% else %}badge-warning{% endif %}">
                                            {% if ishchi.is_oylik_open %}
                                            Faol
                                            {% else %}
                                            Faol emas
                                            {% endif %}
                                        </span>
                                    </span>
                                </div>
                                {% if ishchi.yangi_oylik %}
                                <div class="item-info-row">
                                    <svg width="16" height="16" viewBox="0 0 20 20" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <path d="M1 6s2-2 5-2 5 2 8 2 5-2 5-2v12s-2 2-5 2-5-2-8-2-5 2-5 2V6z" />
                                        <path d="M1 6h14" />
                                    </svg>
                                    <span>Yangi oylik: {{ ishchi.yangi_oylik|floatformat:0 }} so'm</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="item-card-footer">
                            <button class="btn btn-secondary btn-sm"
                                onclick="editIshchi({{ ishchi.id }})">Tahrirlash</button>
                            <button class="btn btn-secondary btn-sm"
                                onclick="deleteIshchi({{ ishchi.id }})">O'chirish</button>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="no-employees">
                        <p>Hozircha ishchilar mavjud emas.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </main>
    </div>
</div>

<div class="modal" id="employeeModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="employeeModalTitle">Yangi ishchi</h3>
            <button class="modal-close" id="closeEmployeeModal">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M5 5l10 10M15 5l-10 10" />
                </svg>
            </button>
        </div>
        <form id="employeeForm" method="POST" action="{% url 'main:ishchi_create' %}">
            {% csrf_token %}
            <div class="form-group">
                <label>Ism</label>
                <input type="text" id="employeeIsm" name="ism" required>
            </div>
            <div class="form-group">
                <label>Familiya</label>
                <input type="text" id="employeeFamiliya" name="familiya" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Telefon</label>
                    <input type="tel" id="employeePhone" name="telefon" required>
                </div>
                <div class="form-group">
                    <label>Maosh (so'm)</label>
                    <input type="number" id="employeeSalary" name="maosh" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Ish turi</label>
                    <select id="employeeType" name="turi" required>
                        <option value="">Tanlang</option>
                        {% for tur in ishchi_turlari %}
                        <option value="{{ tur.id }}">{{ tur.nomi }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="employeeStatus" name="is_oylik_open" required>
                        <option value="true">Faol</option>
                        <option value="false">Faol emas</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Yangi oylik (agar mavjud bo'lsa)</label>
                <input type="number" id="employeeNewSalary" name="yangi_oylik" value="0">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelEmployeeBtn">Bekor qilish</button>
                <button type="submit" class="btn btn-primary">Saqlash</button>
            </div>
        </form>
    </div>
</div>
<script>
    // Ishchilar modalini boshqarish
    const addEmployeeBtn = document.getElementById('addEmployeeBtn');
    const employeeModal = document.getElementById('employeeModal');
    const closeEmployeeModal = document.getElementById('closeEmployeeModal');
    const cancelEmployeeBtn = document.getElementById('cancelEmployeeBtn');
    const employeeForm = document.getElementById('employeeForm');

    addEmployeeBtn.addEventListener('click', () => {
        employeeModal.classList.add('active');
    });

    closeEmployeeModal.addEventListener('click', () => {
        employeeModal.classList.remove('active');
    });

    cancelEmployeeBtn.addEventListener('click', () => {
        employeeModal.classList.remove('active');
    });

    // Ishchini tahrirlash funksiyasi
    function editIshchi(ishchiId) {
        fetch(`/employees/${ishchiId}/update/`)
            .then(response => response.text())
            .then(html => {
                document.getElementById("editModalBody").innerHTML = html;
                document.getElementById("editModal").style.display = "block";
            });
    }

    // Qidiruv funksiyasi
    const employeeSearch = document.getElementById('employeeSearch');
    employeeSearch.addEventListener('input', function () {
        const searchTerm = this.value.toLowerCase();
        const employeeCards = document.querySelectorAll('.item-card');

        employeeCards.forEach(card => {
            const employeeName = card.querySelector('.item-title').textContent.toLowerCase();
            const employeePosition = card.querySelector('.item-subtitle').textContent.toLowerCase();

            if (employeeName.includes(searchTerm) || employeePosition.includes(searchTerm)) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    });

    // Ishchini o'chirish funksiyasi
    function deleteIshchi(id) {
        if (!confirm("Haqiqatan ham o'chirmoqchimisiz?")) return;

        fetch(`/employees/${id}/delete/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": getCookie("csrftoken"),
            },
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === "ok") {
                    alert("Ishchi o'chirildi!");
                    location.reload();
                }
            })
            .catch(err => console.error(err));
    }

</script>
{% endblock content %}
