{% extends 'base.html' %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/ish_qoshish.css' %}">

<style>
/* Qo'shimcha Inline Styles */
.mustaqil-checkbox-wrapper {
    margin-top: 0.75rem;
    padding: 0.75rem;
    background: var(--color-warning-light);
    border-radius: var(--radius);
    border-left: 3px solid var(--color-warning);
}

.mustaqil-checkbox-wrapper label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--color-warning);
}

.mustaqil-checkbox-wrapper input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.date-input-wrapper {
    margin-top: 0.5rem;
}

.date-input-wrapper label {
    display: block;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 0.25rem;
}

.date-input-wrapper input[type="date"] {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    background: var(--bg-card);
    color: var(--text-primary);
    font-size: 0.875rem;
}

.date-input-wrapper input[type="date"]:focus {
    outline: none;
    border-color: var(--color-primary);
}

.info-badge {
    padding: 0.5rem 0.75rem;
    border-radius: 0.375rem;
    font-size: 0.75rem;
    margin-top: 0.5rem;
    display: inline-block;
}

.btn-create-variant {
    margin-top: 0.5rem;
    padding: 0.5rem 0.75rem;
    background: var(--bg-secondary);
    border: 1px dashed var(--border-color);
    border-radius: var(--radius);
    color: var(--text-secondary);
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.15s;
    width: 100%;
}

.btn-create-variant:hover {
    background: var(--color-primary-light);
    border-color: var(--color-primary);
    color: var(--color-primary);
}

.variant-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: var(--bg-card);
    padding: 2rem;
    border-radius: var(--radius);
    width: 90%;
    max-width: 500px;
    box-shadow: var(--shadow-lg);
}

.modal-content h4 {
    font-size: 1.25rem;
    margin-bottom: 1.5rem;
    color: var(--text-primary);
}

.modal-actions {
    display: flex;
    gap: 0.75rem;
    margin-top: 1.5rem;
}

.sarf-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    background: white;
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
    border: 1px solid var(--border-color);
}

.odoo-style-input {
    width: 70px;
    padding: 0.25rem 0.5rem;
    border: 1px solid var(--border-color);
    border-radius: 0.25rem;
    text-align: right;
    font-weight: 600;
    font-size: 0.8125rem;
    background: var(--bg-card);
    color: var(--color-primary);
}

.odoo-style-input:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

/* MULTIPLE TERI STYLES */
.teri-sarflar-container {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 2px dashed var(--border-color);
}

.teri-row {
    padding: 0.75rem;
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border: 1px solid #bae6fd;
    border-radius: var(--radius);
    margin-bottom: 0.75rem;
    position: relative;
    transition: all 0.2s;
}

.teri-row:hover {
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
    transform: translateY(-1px);
}

.teri-row-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.teri-number {
    font-weight: 700;
    color: var(--color-primary);
}

.btn-add-teri {
    padding: 0.5rem 1rem;
    background: var(--color-success);
    color: white;
    border: none;
    border-radius: var(--radius);
    font-size: 0.75rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
}

.btn-add-teri:hover {
    background: #16a34a;
    transform: scale(1.02);
}

.btn-remove-teri {
    margin-top: 0.5rem;
    padding: 0.375rem 0.75rem;
    background: var(--color-danger);
    color: white;
    border: none;
    border-radius: var(--radius);
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-remove-teri:hover {
    background: #dc2626;
}

.variant-select-container {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem;
    background: white;
    border-radius: var(--radius);
    border: 1px solid var(--border-color);
    margin-top: 0.5rem;
}

.variant-label {
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--text-secondary);
    white-space: nowrap;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}
</style>

<div class="app">
    <div class="main-content">
        <main class="content">
            <div class="page">
                <div class="page-header">
                    <div class="breadcrumb">
                        <a href="/">Bosh sahifa</a>
                        <span>/</span>
                        <a href="">Ishlar</a>
                        <span>/</span>
                        <span>Yangi ish qo'shish</span>
                    </div>
                    <h2>Ish qo'shish</h2>
                    <p>Ishchilarga yangi ish biriktirish</p>
                </div>

                {% if messages %}
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
                        {% if message.tags == 'success' %}
                        <path d="M7 10l3 3 6-6" />
                        <circle cx="10" cy="10" r="8" />
                        {% elif message.tags == 'warning' %}
                        <path d="M10 6v4m0 4h.01" />
                        <path d="M3 10l7-7 7 7-7 7-7-7z" />
                        {% else %}
                        <path d="M10 6v4m0 4h.01" />
                        <circle cx="10" cy="10" r="8" />
                        {% endif %}
                    </svg>
                    {{ message }}
                </div>
                {% endfor %}
                {% endif %}

                <div class="workers-table-card">
                    <div class="card-header">
                        <h3>Ishchilar ro'yxati</h3>
                        <div class="search-box">
                            <span class="search-icon">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="7" cy="7" r="5" />
                                    <path d="M11 11l3 3" />
                                </svg>
                            </span>
                            <input type="text" id="searchInput" placeholder="Ishchi qidirish...">
                        </div>
                    </div>

                    {% if ishchilar %}
                    <div class="table-container">
                        <table id="workersTable">
                            <thead>
                                <tr>
                                    <th>Ishchi</th>
                                    <th>Lavozim</th>
                                    <th>Mahsulot</th>
                                    <th>Soni</th>
                                    <th>Amal</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for ishchi in ishchilar %}
                                <tr class="worker-row" data-turi="{{ ishchi.turi.nomi|lower }}">
                                    <td>
                                        <div class="worker-info">
                                            <div class="worker-avatar">{{ ishchi.ism|slice:":1"|upper }}</div>
                                            <div class="worker-details">
                                                <span class="worker-name">{{ ishchi.ism }}</span>
                                                <span class="worker-phone">{{ ishchi.telefon }}</span>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge {% if ishchi.turi.nomi|lower == 'kroy' or ishchi.turi.nomi|lower == 'rezak' %}badge-warning{% elif ishchi.turi.nomi|lower == 'kosib' %}badge-success{% else %}badge-primary{% endif %}">
                                            {{ ishchi.turi.nomi }}
                                        </span>
                                    </td>
                                    <td colspan="3">
                                        <form method="post" class="work-form" data-ishchi-turi="{{ ishchi.turi.nomi|lower }}">
                                            {% csrf_token %}
                                            <input type="hidden" name="ishchi" value="{{ ishchi.id }}">

                                            <!-- ASOSIY FORM -->
                                            <div class="form-group">
                                                <select name="mahsulot" class="form-select mahsulot-select" required
                                                    data-row="{{ forloop.counter }}"
                                                    data-ishchi-turi="{{ ishchi.turi.nomi|lower }}">
                                                    <option value="">Mahsulot...</option>
                                                    {% for mahsulot in mahsulotlar %}
                                                    <option value="{{ mahsulot.id }}"
                                                        data-teri-sarfi="{{ mahsulot.teri_sarfi }}"
                                                        data-astar-sarfi="{{ mahsulot.astar_sarfi }}">
                                                        {{ mahsulot.nomi }}
                                                    </option>
                                                    {% endfor %}
                                                </select>

                                                <input type="number" name="soni" class="form-input soni-input"
                                                    placeholder="Soni" min="1" required data-row="{{ forloop.counter }}">

                                                <button type="submit" class="btn btn-success">
                                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M8 3v10M3 8h10" />
                                                    </svg>
                                                    Qo'shish
                                                </button>
                                            </div>

                                            <!-- ISH SANASI -->
                                            <div class="date-input-wrapper">
                                                <label>üìÖ Ish sanasi:</label>
                                                <input type="date" name="ish_sanasi" class="date-input" required>
                                            </div>

                                            <!-- MUSTAQIL ISH CHECKBOX (faqat Zakatovka va Kosib uchun) -->
                                            {% if ishchi.turi.nomi|lower == 'zakatovka' or ishchi.turi.nomi|lower == 'kosib' %}
                                            <div class="mustaqil-checkbox-wrapper">
                                                <label>
                                                    <input type="checkbox" name="mustaqil_ish" class="mustaqil-checkbox"
                                                        data-row="{{ forloop.counter }}">
                                                    <span>‚ö° Mustaqil ish (xomashyosiz qo'shish)</span>
                                                </label>
                                            </div>
                                            {% endif %}

                                            <!-- ZAKATOVKA UCHUN -->
                                            {% if ishchi.turi.nomi|lower == 'zakatovka' %}
                                            <div class="kroy-extra-fields" id="zakatovka-fields-{{ forloop.counter }}">
                                                <div class="extra-field">
                                                    <label class="field-label">üü¶ Kroy xomashyosi:</label>
                                                    <select name="kroy_xomashyo" class="form-select kroy-select"
                                                        data-row="{{ forloop.counter }}">
                                                        <option value="">Kroy xomashyo tanlang...</option>
                                                    </select>
                                                    <div class="info-badge" style="background: #dbeafe; color: #1e40af;">
                                                        ‚ÑπÔ∏è Kroy jarayonidan chiqqan yarim tayyor mahsulot
                                                    </div>
                                                </div>
                                            </div>
                                            {% endif %}

                                            <!-- KROY VA REZAK UCHUN - MULTIPLE TERI -->
                                            {% if ishchi.turi.nomi|lower == 'kroy' or ishchi.turi.nomi|lower == 'rezak' %}
                                            <div class="kroy-extra-fields" id="{{ ishchi.turi.nomi|lower }}-fields-{{ forloop.counter }}">
                                                
                                                <!-- TERI SARFLARI (Multiple) -->
                                                <div class="teri-sarflar-container" id="teri-container-{{ forloop.counter }}">
                                                    <div class="section-header">
                                                        <label style="font-size: 0.875rem; font-weight: 600; color: var(--color-primary);">
                                                            üî∑ Teri sarflari
                                                        </label>
                                                        <button type="button" class="btn-add-teri" onclick="addTeriRow({{ forloop.counter }})">
                                                            ‚ûï Teri qo'shish
                                                        </button>
                                                    </div>

                                                    <!-- Teri Row 1 (Default) -->
                                                    <div class="teri-row" data-row="{{ forloop.counter }}" data-teri-index="1">
                                                        <div class="teri-row-header">
                                                            <span style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary);">
                                                                Teri #<span class="teri-number">1</span>
                                                            </span>
                                                            <div class="sarf-badge">
                                                                <input type="number" step="0.01" name="teri_sarfi_custom[]" 
                                                                    class="odoo-style-input teri-sarf-input" 
                                                                    data-row="{{ forloop.counter }}"
                                                                    data-teri-index="1"
                                                                    placeholder="0.00">
                                                                <span style="font-size: 0.75rem; color: var(--text-tertiary);">Dm</span>
                                                            </div>
                                                        </div>
                                                        
                                                        <div style="display: grid; gap: 0.5rem;">
                                                            <select name="teri_xomashyo[]" class="form-select xomashyo-select teri-select" required 
                                                                data-row="{{ forloop.counter }}" data-teri-index="1" data-type="teri">
                                                                <option value="">Teri tanlang...</option>
                                                                {% for teri in terilar %}
                                                                <option value="{{ teri.id }}" 
                                                                        data-miqdor="{{ teri.miqdori }}"
                                                                        data-has-variants="{% if teri.variantlar.exists %}true{% else %}false{% endif %}">
                                                                    {{ teri.nomi }} ({{ teri.miqdori }} {{ teri.get_olchov_birligi_display }})
                                                                </option>
                                                                {% endfor %}
                                                            </select>

                                                            <div class="variant-select-container teri-variant-container" 
                                                                 id="teri-variant-{{ forloop.counter }}-1" style="display:none;">
                                                                <span class="variant-label">üì¶ Variant:</span>
                                                                <select name="teri_variant[]" class="form-select variant-select teri-variant-select"></select>
                                                            </div>
                                                        </div>

                                                        <button type="button" class="btn-remove-teri" onclick="removeTeriRow(this)" 
                                                                style="display: none;">
                                                            üóëÔ∏è O'chirish
                                                        </button>
                                                    </div>
                                                </div>

                                                <!-- ASTAR (yagona) -->
                                                <div class="extra-field" style="margin-top: 1rem; padding-top: 1rem; border-top: 2px dashed var(--border-color);">
                                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                                        <label style="font-size: 0.75rem; font-weight: 600; color: var(--color-warning);">üî∂ Astar xomashyo:</label>
                                                        <div class="sarf-badge">
                                                            <input type="number" step="0.01" name="astar_sarfi_custom" 
                                                                id="astar-sarf-{{ forloop.counter }}"
                                                                class="odoo-style-input" 
                                                                data-row="{{ forloop.counter }}"
                                                                placeholder="0.00">
                                                            <span style="font-size: 0.75rem; color: var(--text-tertiary);">Dm</span>
                                                        </div>
                                                    </div>

                                                    <select name="astar_xomashyo" class="form-select xomashyo-select" 
                                                        data-row="{{ forloop.counter }}" data-type="astar">
                                                        <option value="">Astar kerak emas</option>
                                                        {% for astar in astarlar %}
                                                        <option value="{{ astar.id }}" 
                                                                data-miqdor="{{ astar.miqdori }}"
                                                                data-has-variants="{% if astar.variantlar.exists %}true{% else %}false{% endif %}">
                                                            {{ astar.nomi }} ({{ astar.miqdori }} {{ astar.get_olchov_birligi_display }})
                                                        </option>
                                                        {% endfor %}
                                                    </select>

                                                    <div class="variant-select-container" id="astar-variant-{{ forloop.counter }}" style="display:none;">
                                                        <span class="variant-label">üì¶ Variant:</span>
                                                        <select name="astar_variant" class="form-select variant-select"></select>
                                                    </div>
                                                </div>
                                                
                                                <!-- SARFLAR INFO -->
                                                <div class="sarflar-info" id="sarflar-{{ forloop.counter }}" 
                                                    style="margin-top: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: var(--radius); font-size: 0.75rem;">
                                                    ‚ÑπÔ∏è Avtomatik hisoblash rejimi faol
                                                </div>
                                            </div>
                                            {% endif %}

                                            <!-- KOSIB UCHUN -->
                                            {% if ishchi.turi.nomi|lower == 'kosib' %}
                                            <div class="kroy-extra-fields" id="kosib-fields-{{ forloop.counter }}">
                                                <!-- MAHSULOT VARIANT -->
                                                <div class="extra-field">
                                                    <label class="field-label">üé® Mahsulot varianti:</label>
                                                    <select name="mahsulot_variant" class="form-select variant-product-select" 
                                                        data-row="{{ forloop.counter }}">
                                                        <option value="">Avval mahsulot tanlang...</option>
                                                    </select>
                                                    
                                                    <button type="button" class="btn-create-variant" 
                                                        onclick="showVariantModal({{ forloop.counter }})">
                                                        ‚ûï Yangi variant yaratish
                                                    </button>
                                                </div>

                                                <!-- VARIANT MODAL -->
                                                <div class="variant-modal" id="variant-modal-{{ forloop.counter }}">
                                                    <div class="modal-content">
                                                        <h4>üé® Yangi variant yaratish</h4>
                                                        <div style="margin-bottom: 1rem;">
                                                            <label style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">Rang:</label>
                                                            <input type="text" class="form-input" style="width: 100%;"
                                                                id="new-variant-rang-{{ forloop.counter }}" 
                                                                placeholder="Qora, Oq, Jigarrang...">
                                                        </div>
                                                        <div style="margin-bottom: 1rem;">
                                                            <label style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">Razmer:</label>
                                                            <input type="text" class="form-input" style="width: 100%;"
                                                                id="new-variant-razmer-{{ forloop.counter }}" 
                                                                placeholder="38, 39, 40...">
                                                        </div>
                                                        <div class="modal-actions">
                                                            <button type="button" class="btn btn-primary" 
                                                                onclick="createNewVariant({{ forloop.counter }})">
                                                                ‚úÖ Yaratish
                                                            </button>
                                                            <button type="button" class="btn" style="background: var(--bg-secondary);"
                                                                onclick="hideVariantModal({{ forloop.counter }})">
                                                                ‚ùå Bekor qilish
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- ZAKATOVKA -->
                                                <div class="extra-field">
                                                    <label class="field-label">üü¶ Zakatovka xomashyo:</label>
                                                    <select name="zakatovka_xomashyo" class="form-select zakatovka-select" 
                                                        data-row="{{ forloop.counter }}">
                                                        <option value="">Avval mahsulot tanlang...</option>
                                                    </select>
                                                </div>

                                                <!-- PADOJ -->
                                                <div class="extra-field">
                                                    <label class="field-label">üü® Padoj xomashyo:</label>
                                                    <select name="padoj_xomashyo" class="form-select xomashyo-select" required
                                                        data-row="{{ forloop.counter }}" data-type="padoj">
                                                        <option value="">Padoj tanlang...</option>
                                                        {% for padoj in padojlar %}
                                                        <option value="{{ padoj.id }}"
                                                            data-has-variants="{% if padoj.variantlar.exists %}true{% else %}false{% endif %}"
                                                            data-miqdor="{{ padoj.miqdori }}">
                                                            {{ padoj.nomi }} ({{ padoj.miqdori }} dona)
                                                        </option>
                                                        {% endfor %}
                                                    </select>

                                                    <div class="variant-select-container" id="padoj-variant-{{ forloop.counter }}" style="display:none;">
                                                        <span class="variant-label">üì¶ Variant:</span>
                                                        <select name="padoj_variant" class="form-select variant-select"></select>
                                                    </div>
                                                </div>

                                                <div class="info-badge" style="background: #dcfce7; color: #16a34a;">
                                                    ‚úÖ Product.soni va variant stock avtomatik ortadi
                                                </div>
                                            </div>
                                            {% endif %}

                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <div class="empty-icon">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="8" r="5" />
                                <path d="M3 21c0-5 4-9 9-9s9 4 9 9" />
                            </svg>
                        </div>
                        <h4 class="empty-title">Ishchilar topilmadi</h4>
                        <p class="empty-description">Hozircha hech qanday ishchi ro'yxatga olinmagan</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </main>
    </div>
</div>

<script>
let teriCounter = {};

// ============================================================================
// TERI QATORLARINI BOSHQARISH
// ============================================================================
function addTeriRow(rowNum) {
    if (!teriCounter[rowNum]) {
        teriCounter[rowNum] = 1;
    }
    teriCounter[rowNum]++;
    
    const container = document.getElementById(`teri-container-${rowNum}`);
    const newIndex = teriCounter[rowNum];
    
    const newRow = document.createElement('div');
    newRow.className = 'teri-row';
    newRow.dataset.row = rowNum;
    newRow.dataset.teriIndex = newIndex;
    
    newRow.innerHTML = `
        <div class="teri-row-header">
            <span style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary);">
                Teri #<span class="teri-number">${newIndex}</span>
            </span>
            <div class="sarf-badge">
                <input type="number" step="0.01" name="teri_sarfi_custom[]" 
                    class="odoo-style-input teri-sarf-input" 
                    data-row="${rowNum}"
                    data-teri-index="${newIndex}"
                    placeholder="0.00">
                <span style="font-size: 0.75rem; color: var(--text-tertiary);">Dm</span>
            </div>
        </div>
        
        <div style="display: grid; gap: 0.5rem;">
            <select name="teri_xomashyo[]" class="form-select xomashyo-select teri-select" required 
                data-row="${rowNum}" data-teri-index="${newIndex}" data-type="teri">
                <option value="">Teri tanlang...</option>
                {% for teri in terilar %}
                <option value="{{ teri.id }}" 
                        data-miqdor="{{ teri.miqdori }}"
                        data-has-variants="{% if teri.variantlar.exists %}true{% else %}false{% endif %}">
                    {{ teri.nomi }} ({{ teri.miqdori }} {{ teri.get_olchov_birligi_display }})
                </option>
                {% endfor %}
            </select>

            <div class="variant-select-container teri-variant-container" 
                 id="teri-variant-${rowNum}-${newIndex}" style="display:none;">
                <span class="variant-label">üì¶ Variant:</span>
                <select name="teri_variant[]" class="form-select variant-select teri-variant-select"></select>
            </div>
        </div>

        <button type="button" class="btn-remove-teri" onclick="removeTeriRow(this)">
            üóëÔ∏è O'chirish
        </button>
    `;
    
    container.appendChild(newRow);
    
    // Event listeners qo'shish
    const select = newRow.querySelector('.teri-select');
    select.addEventListener('change', function() {
        handleTeriSelect(this, rowNum, newIndex);
    });
    
    const sarfInput = newRow.querySelector('.teri-sarf-input');
    sarfInput.addEventListener('input', function() {
        updateTotalSarflar(rowNum);
    });
    
    sarfInput.addEventListener('focus', function() {
        this.select();
    });
    
    sarfInput.addEventListener('blur', function() {
        if (this.value) {
            this.value = parseFloat(this.value).toFixed(2);
        }
    });
    
    // Birinchi qatorga remove tugmasi qo'shish
    updateRemoveButtons(rowNum);
}

function removeTeriRow(button) {
    const row = button.closest('.teri-row');
    const rowNum = row.dataset.row;
    
    row.remove();
    
    // Raqamlarni qayta hisoblash
    renumberTeriRows(rowNum);
    updateRemoveButtons(rowNum);
    updateTotalSarflar(rowNum);
}

function renumberTeriRows(rowNum) {
    const container = document.getElementById(`teri-container-${rowNum}`);
    const rows = container.querySelectorAll('.teri-row');
    
    rows.forEach((row, index) => {
        const number = index + 1;
        row.querySelector('.teri-number').textContent = number;
        row.dataset.teriIndex = number;
    });
    
    teriCounter[rowNum] = rows.length;
}

function updateRemoveButtons(rowNum) {
    const container = document.getElementById(`teri-container-${rowNum}`);
    const rows = container.querySelectorAll('.teri-row');
    const removeButtons = container.querySelectorAll('.btn-remove-teri');
    
    if (rows.length === 1) {
        removeButtons.forEach(btn => btn.style.display = 'none');
    } else {
        removeButtons.forEach(btn => btn.style.display = 'block');
    }
}

function handleTeriSelect(selectElement, rowNum, teriIndex) {
    const xomashyoId = selectElement.value;
    const selectedOption = selectElement.options[selectElement.selectedIndex];
    const hasVariants = selectedOption.dataset.hasVariants === 'true';
    
    const variantContainer = document.getElementById(`teri-variant-${rowNum}-${teriIndex}`);
    const variantSelect = variantContainer ? variantContainer.querySelector('.teri-variant-select') : null;
    
    if (!variantContainer || !variantSelect) return;
    
    if (!xomashyoId) {
        variantContainer.style.display = 'none';
        return;
    }
    
    if (hasVariants) {
        fetch(`/uyapi/xomashyo/${xomashyoId}/variants/`)
            .then(res => res.json())
            .then(data => {
                if (data.success && data.variants.length > 0) {
                    variantSelect.innerHTML = '<option value="">Variant tanlang...</option>';
                    data.variants.forEach(v => {
                        const label = `${v.rang || 'Rangsiz'} - ${v.miqdori} ${v.olchov_birligi}`;
                        variantSelect.innerHTML += `<option value="${v.id}">${label}</option>`;
                    });
                    variantContainer.style.display = 'flex';
                } else {
                    variantContainer.style.display = 'none';
                }
            })
            .catch(err => {
                console.error(err);
                variantContainer.style.display = 'none';
            });
    } else {
        variantContainer.style.display = 'none';
    }
    
    // Default sarfni to'ldirish
    const sarfInput = selectElement.closest('.teri-row').querySelector('.teri-sarf-input');
    const mahsulotSelect = document.querySelector(`.mahsulot-select[data-row="${rowNum}"]`);
    
    if (sarfInput && mahsulotSelect && mahsulotSelect.value) {
        const mahsulotOption = mahsulotSelect.options[mahsulotSelect.selectedIndex];
        const defaultSarf = parseFloat(mahsulotOption.dataset.teriSarfi) || 0;
        
        if (defaultSarf > 0 && !sarfInput.value) {
            sarfInput.value = defaultSarf.toFixed(2);
        }
    }
    
    updateTotalSarflar(rowNum);
}

function updateTotalSarflar(rowNum) {
    const soniInput = document.querySelector(`.soni-input[data-row="${rowNum}"]`);
    const sarflarInfo = document.getElementById(`sarflar-${rowNum}`);
    const astarSarfInput = document.getElementById(`astar-sarf-${rowNum}`);
    
    if (!sarflarInfo) return;
    
    const soni = parseInt(soniInput?.value) || 0;
    const astarSarf = parseFloat(astarSarfInput?.value) || 0;
    
    // Barcha teri sarflarini yig'ish
    const container = document.getElementById(`teri-container-${rowNum}`);
    const teriRows = container.querySelectorAll('.teri-row');
    
    let teriSarflar = [];
    let jamiTeriSarf = 0;
    
    teriRows.forEach((row, index) => {
        const sarfInput = row.querySelector('.teri-sarf-input');
        const teriSelect = row.querySelector('.teri-select');
        const sarf = parseFloat(sarfInput?.value) || 0;
        const teriName = teriSelect?.selectedOptions[0]?.text.split('(')[0].trim() || `Teri #${index + 1}`;
        
        if (sarf > 0) {
            const jami = sarf * soni;
            teriSarflar.push({ name: teriName, sarf, jami });
            jamiTeriSarf += jami;
        }
    });
    
    if (soni > 0 && (teriSarflar.length > 0 || astarSarf > 0)) {
        let html = '<div style="display: grid; gap: 0.5rem;">';
        
        // Teri sarflari
        if (teriSarflar.length > 0) {
            html += '<div style="font-weight: 600; color: var(--color-primary); margin-bottom: 0.25rem;">üî∑ Teri sarflari:</div>';
            teriSarflar.forEach((t, i) => {
                html += `<div style="display: flex; justify-content: space-between; padding-left: 1rem;">
                    <span>${i + 1}. ${t.name}:</span>
                    <strong style="color: var(--color-primary);">${t.sarf} Dm √ó ${soni} = ${t.jami.toFixed(2)} Dm</strong>
                </div>`;
            });
            
            if (teriSarflar.length > 1) {
                html += `<div style="display: flex; justify-content: space-between; padding: 0.5rem 1rem; background: white; border-radius: 0.375rem; margin-top: 0.25rem;">
                    <span style="font-weight: 600;">JAMI:</span>
                    <strong style="color: var(--color-primary); font-size: 1.125rem;">${jamiTeriSarf.toFixed(2)} Dm</strong>
                </div>`;
            }
        }
        
        // Astar sarfi
        if (astarSarf > 0) {
            const astarJami = (astarSarf * soni).toFixed(2);
            html += `<div style="display: flex; justify-content: space-between; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px dashed var(--border-color);">
                <span>üî∂ Astar:</span>
                <strong style="color: var(--color-warning);">${astarSarf} Dm √ó ${soni} = ${astarJami} Dm</strong>
            </div>`;
        }
        
        html += '</div>';
        sarflarInfo.innerHTML = html;
        sarflarInfo.style.background = '#dcfce7';
        sarflarInfo.style.borderLeft = '4px solid var(--color-success)';
    } else {
        sarflarInfo.innerHTML = '‚ö†Ô∏è Sonini va sarflarni kiriting';
        sarflarInfo.style.background = 'var(--bg-secondary)';
        sarflarInfo.style.borderLeft = 'none';
    }
}

// ============================================================================
// DOCUMENT READY
// ============================================================================
document.addEventListener('DOMContentLoaded', function () {
    // Bugungi sanani o'rnatish
    const today = new Date().toISOString().split('T')[0];
    document.querySelectorAll('.date-input').forEach(input => {
        input.value = today;
    });

    // ============================================================================
    // QIDIRUV
    // ============================================================================
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('input', function (e) {
            const searchTerm = e.target.value.toLowerCase();
            document.querySelectorAll('.worker-row').forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });
    }

    // ============================================================================
    // MUSTAQIL ISH CHECKBOX
    // ============================================================================
    document.querySelectorAll('.mustaqil-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const rowNum = this.dataset.row;
            const form = this.closest('form');
            const ishchiTuri = form.dataset.ishchiTuri;
            
            if (ishchiTuri === 'zakatovka') {
                const kroySelect = form.querySelector('.kroy-select');
                if (kroySelect) {
                    kroySelect.required = !this.checked;
                    if (this.checked) {
                        kroySelect.value = '';
                        kroySelect.style.opacity = '0.5';
                    } else {
                        kroySelect.style.opacity = '1';
                    }
                }
            } else if (ishchiTuri === 'kosib') {
                const zakatovkaSelect = form.querySelector('.zakatovka-select');
                if (zakatovkaSelect) {
                    zakatovkaSelect.required = !this.checked;
                    if (this.checked) {
                        zakatovkaSelect.value = '';
                        zakatovkaSelect.style.opacity = '0.5';
                    } else {
                        zakatovkaSelect.style.opacity = '1';
                    }
                }
            }
        });
    });

    // ============================================================================
    // MAHSULOT O'ZGARGANDA
    // ============================================================================
    document.querySelectorAll('.mahsulot-select').forEach(select => {
        select.addEventListener('change', function () {
            const rowNum = this.dataset.row;
            const ishchiTuri = this.dataset.ishchiTuri;
            const mahsulotId = this.value;

            const fields = document.getElementById(`${ishchiTuri}-fields-${rowNum}`);
            if (fields) fields.classList.remove('show');

            if (!mahsulotId) return;

            if (ishchiTuri === 'zakatovka') {
                const zakFields = document.getElementById(`zakatovka-fields-${rowNum}`);
                if (zakFields) zakFields.classList.add('show');
                loadKroyXomashyolar(mahsulotId, rowNum);
            } else if (ishchiTuri === 'kroy' || ishchiTuri === 'rezak') {
                if (fields) {
                    fields.classList.add('show');
                    updateKroySarfInputs(this, rowNum);
                }
            } else if (ishchiTuri === 'kosib') {
                if (fields) {
                    fields.classList.add('show');
                    loadZakatovkaXomashyolar(mahsulotId, rowNum);
                    loadProductVariants(mahsulotId, rowNum);
                }
            }
        });
    });

    // ============================================================================
    // AJAX YUKLASH FUNKSIYALARI
    // ============================================================================
    function loadKroyXomashyolar(mahsulotId, rowNum) {
        const select = document.querySelector(`.kroy-select[data-row="${rowNum}"]`);
        if (!select) return;

        select.innerHTML = '<option value="">‚è≥ Yuklanmoqda...</option>';

        fetch(`/uyapi/mahsulot/${mahsulotId}/kroy-xomashyolar/`)
            .then(res => res.json())
            .then(data => {
                select.innerHTML = '<option value="">Kroy tanlang...</option>';
                if (data.success && data.xomashyolar.length > 0) {
                    data.xomashyolar.forEach(x => {
                        select.innerHTML += `<option value="${x.id}">${x.nomi} (${x.miqdori} ${x.olchov_birligi})</option>`;
                    });
                } else {
                    select.innerHTML += '<option value="">‚ùå Kroy jarayoni yo\'q (mustaqil ish tanlang)</option>';
                }
            })
            .catch(err => {
                console.error(err);
                select.innerHTML = '<option value="">‚ùå Xatolik</option>';
            });
    }

    function loadZakatovkaXomashyolar(mahsulotId, rowNum) {
        const select = document.querySelector(`.zakatovka-select[data-row="${rowNum}"]`);
        if (!select) return;

        select.innerHTML = '<option value="">‚è≥ Yuklanmoqda...</option>';

        fetch(`/uyapi/mahsulot/${mahsulotId}/zakatovka-xomashyolar/`)
            .then(res => res.json())
            .then(data => {
                select.innerHTML = '<option value="">Zakatovka tanlang...</option>';
                if (data.success && data.xomashyolar.length > 0) {
                    data.xomashyolar.forEach(x => {
                        select.innerHTML += `<option value="${x.id}">${x.nomi} (${x.miqdori} ${x.olchov_birligi})</option>`;
                    });
                } else {
                    select.innerHTML += '<option value="">‚ùå Zakatovka yo\'q (mustaqil ish tanlang)</option>';
                }
            })
            .catch(err => {
                console.error(err);
                select.innerHTML = '<option value="">‚ùå Xatolik</option>';
            });
    }

    function loadProductVariants(mahsulotId, rowNum) {
        const variantSelect = document.querySelector(`.variant-product-select[data-row="${rowNum}"]`);
        if (!variantSelect) return;

        variantSelect.innerHTML = '<option value="">‚è≥ Yuklanmoqda...</option>';

        fetch(`/uyapi/mahsulot/${mahsulotId}/variants/`)
            .then(res => res.json())
            .then(data => {
                variantSelect.innerHTML = '<option value="">Variant tanlang...</option>';
                if (data.success && data.variants.length > 0) {
                    data.variants.forEach(v => {
                        const label = `${v.rang || 'Rangsiz'} - ${v.razmer || 'Razmersiz'} (Stock: ${v.stock})`;
                        variantSelect.innerHTML += `<option value="${v.id}" data-rang="${v.rang || ''}" data-razmer="${v.razmer || ''}">${label}</option>`;
                    });
                } else {
                    variantSelect.innerHTML += '<option value="">Variant yo\'q - Yangi yarating</option>';
                }
            })
            .catch(err => {
                console.error(err);
                variantSelect.innerHTML = '<option value="">‚ùå Xatolik</option>';
            });
    }

    // ============================================================================
    // XOMASHYO VARIANT YUKLASH (ASTAR VA PADOJ)
    // ============================================================================
    document.querySelectorAll('.xomashyo-select').forEach(select => {
        select.addEventListener('change', function() {
            const rowNum = this.dataset.row;
            const type = this.dataset.type;
            const xomashyoId = this.value;
            const selectedOption = this.options[this.selectedIndex];
            
            // Faqat astar va padoj uchun (teri uchun handleTeriSelect ishlatiladi)
            if (type === 'teri') return;
            
            const variantContainer = document.getElementById(`${type}-variant-${rowNum}`);
            const variantSelect = variantContainer ? variantContainer.querySelector('.variant-select') : null;
            
            if (!variantContainer || !variantSelect) return;
            
            if (!xomashyoId) {
                variantContainer.style.display = 'none';
                return;
            }
            
            const hasVariants = selectedOption.dataset.hasVariants === 'true';
            
            if (hasVariants) {
                fetch(`/uyapi/xomashyo/${xomashyoId}/variants/`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.success && data.variants.length > 0) {
                            variantSelect.innerHTML = '<option value="">Variant tanlang...</option>';
                            data.variants.forEach(v => {
                                const label = `${v.rang || 'Rangsiz'} - ${v.miqdori} ${v.olchov_birligi}`;
                                variantSelect.innerHTML += `<option value="${v.id}">${label}</option>`;
                            });
                            variantContainer.style.display = 'flex';
                        } else {
                            variantContainer.style.display = 'none';
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        variantContainer.style.display = 'none';
                    });
            } else {
                variantContainer.style.display = 'none';
            }
            
            // Astar uchun sarf inputni to'ldirish
            if (type === 'astar') {
                const sarfInput = document.getElementById(`astar-sarf-${rowNum}`);
                const mahsulotSelect = document.querySelector(`.mahsulot-select[data-row="${rowNum}"]`);
                
                if (sarfInput && mahsulotSelect && mahsulotSelect.value) {
                    const mahsulotOption = mahsulotSelect.options[mahsulotSelect.selectedIndex];
                    const defaultSarf = parseFloat(mahsulotOption.dataset.astarSarfi) || 0;
                    
                    if (defaultSarf > 0 && !sarfInput.value) {
                        sarfInput.value = defaultSarf.toFixed(2);
                        sarfInput.style.backgroundColor = '#d4edda';
                        setTimeout(() => sarfInput.style.backgroundColor = 'transparent', 500);
                    }
                }
            }
        });
    });

    // ============================================================================
    // TERI SELECT EVENT LISTENERS (Initial rows)
    // ============================================================================
    document.querySelectorAll('.teri-select').forEach(select => {
        select.addEventListener('change', function() {
            const rowNum = this.dataset.row;
            const teriIndex = this.dataset.teriIndex;
            handleTeriSelect(this, rowNum, teriIndex);
        });
    });

    // ============================================================================
    // SONI O'ZGARGANDA
    // ============================================================================
    document.querySelectorAll('.soni-input').forEach(input => {
        input.addEventListener('input', function() {
            const rowNum = this.dataset.row;
            updateTotalSarflar(rowNum);
        });
    });

    // ============================================================================
    // SARF INPUTS
    // ============================================================================
    document.querySelectorAll('.teri-sarf-input, .odoo-style-input').forEach(input => {
        input.addEventListener('input', function() {
            const rowNum = this.dataset.row;
            updateTotalSarflar(rowNum);
        });
        
        input.addEventListener('focus', function() {
            this.select();
        });
        
        input.addEventListener('blur', function() {
            if (this.value) {
                this.value = parseFloat(this.value).toFixed(2);
            }
        });
    });

    function updateKroySarfInputs(mahsulotSelect, rowNum) {
        const selectedOption = mahsulotSelect.options[mahsulotSelect.selectedIndex];
        const soniInput = document.querySelector(`.soni-input[data-row="${rowNum}"]`);
        const astarSarfInput = document.getElementById(`astar-sarf-${rowNum}`);

        if (!selectedOption.value || !soniInput?.value) {
            if (astarSarfInput) astarSarfInput.value = '';
            return;
        }

        const astarSarfiBir = parseFloat(selectedOption.dataset.astarSarfi) || 0;

        if (astarSarfInput && !astarSarfInput.value && astarSarfiBir > 0) {
            astarSarfInput.value = astarSarfiBir.toFixed(2);
        }

        updateTotalSarflar(rowNum);
    }

    // ============================================================================
    // FORM VALIDATSIYA
    // ============================================================================
    document.querySelectorAll('.work-form').forEach(form => {
        form.addEventListener('submit', function (e) {
            const ishchiTuri = form.dataset.ishchiTuri;
            const mahsulot = form.querySelector('[name="mahsulot"]')?.value;
            const soni = form.querySelector('[name="soni"]')?.value;
            const mustaqilIsh = form.querySelector('[name="mustaqil_ish"]')?.checked;
            const ishSanasi = form.querySelector('[name="ish_sanasi"]')?.value;

            if (!mahsulot || !soni || soni < 1) {
                e.preventDefault();
                alert('‚ùå Iltimos mahsulot va sonini to\'ldiring!');
                return;
            }

            if (!ishSanasi) {
                e.preventDefault();
                alert('‚ùå Iltimos ish sanasini tanlang!');
                return;
            }

            if (ishchiTuri === 'zakatovka' && !mustaqilIsh) {
                const kroy = form.querySelector('[name="kroy_xomashyo"]');
                if (!kroy?.value) {
                    e.preventDefault();
                    alert('‚ùå Kroy xomashyosi tanlang yoki "Mustaqil ish" belgisini yoqing!');
                    return;
                }
            }

            if (ishchiTuri === 'kroy' || ishchiTuri === 'rezak') {
                const teriSelects = form.querySelectorAll('[name="teri_xomashyo[]"]');
                let hasTeri = false;
                teriSelects.forEach(select => {
                    if (select.value) hasTeri = true;
                });
                
                if (!hasTeri) {
                    e.preventDefault();
                    alert(`‚ùå ${ishchiTuri.charAt(0).toUpperCase() + ishchiTuri.slice(1)} uchun kamida bitta teri tanlash majburiy!`);
                    return;
                }
            }

            if (ishchiTuri === 'kosib') {
                const padoj = form.querySelector('[name="padoj_xomashyo"]');
                if (!padoj?.value) {
                    e.preventDefault();
                    alert('‚ùå Kosib uchun padoj tanlash majburiy!');
                    return;
                }
                
                if (!mustaqilIsh) {
                    const zakatovka = form.querySelector('[name="zakatovka_xomashyo"]');
                    if (!zakatovka?.value) {
                        e.preventDefault();
                        alert('‚ùå Zakatovka xomashyosi tanlang yoki "Mustaqil ish" belgisini yoqing!');
                        return;
                    }
                }
            }
        });
    });
});

// ============================================================================
// VARIANT MODAL FUNKSIYALARI (Global scope)
// ============================================================================
function showVariantModal(rowNum) {
    const modal = document.getElementById(`variant-modal-${rowNum}`);
    if (modal) modal.style.display = 'flex';
}

function hideVariantModal(rowNum) {
    const modal = document.getElementById(`variant-modal-${rowNum}`);
    if (modal) modal.style.display = 'none';
}

function createNewVariant(rowNum) {
    const rang = document.getElementById(`new-variant-rang-${rowNum}`).value.trim();
    const razmer = document.getElementById(`new-variant-razmer-${rowNum}`).value.trim();

    if (!rang && !razmer) {
        alert('‚ùå Kamida rang yoki razmer kiriting!');
        return;
    }

    const variantSelect = document.querySelector(`.variant-product-select[data-row="${rowNum}"]`);
    if (variantSelect) {
        const newOption = document.createElement('option');
        newOption.value = 'new';
        newOption.dataset.rang = rang;
        newOption.dataset.razmer = razmer;
        newOption.textContent = `üÜï Yangi: ${rang || 'Rangsiz'} - ${razmer || 'Razmersiz'}`;
        newOption.selected = true;

        variantSelect.appendChild(newOption);

        const form = variantSelect.closest('form');

        let rangInput = form.querySelector('input[name="variant_rang"]');
        if (!rangInput) {
            rangInput = document.createElement('input');
            rangInput.type = 'hidden';
            rangInput.name = 'variant_rang';
            form.appendChild(rangInput);
        }
        rangInput.value = rang;

        let razmerInput = form.querySelector('input[name="variant_razmer"]');
        if (!razmerInput) {
            razmerInput = document.createElement('input');
            razmerInput.type = 'hidden';
            razmerInput.name = 'variant_razmer';
            form.appendChild(razmerInput);
        }
        razmerInput.value = razmer;
    }

    hideVariantModal(rowNum);

    document.getElementById(`new-variant-rang-${rowNum}`).value = '';
    document.getElementById(`new-variant-razmer-${rowNum}`).value = '';
}
</script>
{% endblock content %}